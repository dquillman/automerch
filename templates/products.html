{% extends 'base.html' %}
{% block content %}
  <h1>Products</h1>
  {% if products %}
  <form method="post" action="/api/products/bulk/etsy_draft">
  <div class="table-wrap">\n  <table>
    <thead><tr><th>SKU</th><th>Name</th><th>Price</th><th>Etsy</th><th>Printful</th><th>Actions</th></tr></thead>
    <tbody>
      {% for p in products %}
        <tr>
          <td>
            <label><input type="checkbox" name="skus" value="{{ p.sku }}" /> {{ p.sku }}</label>
          </td>
          <td>{{ p.name or '' }}</td>
          <td>{{ '%.2f' % p.price if p.price is not none else '' }}</td>
          <td>{{ p.etsy_listing_id or '' }}</td>
          <td>{{ p.printful_variant_id or '' }}</td>
          <td>
            <details>
              <summary>Edit</summary>
              <form method="post" action="/api/products/update">
                <input type="hidden" name="sku" value="{{ p.sku }}" />
                <input type="text" name="name" placeholder="Name" value="{{ p.name or '' }}" />
                <input type="text" name="price" placeholder="Price" value="{{ p.price or '' }}" />
                <input list="variants" type="text" name="variant_id" placeholder="Printful variant id (e.g., 4011)" value="{{ p.variant_id or '' }}" />
                <datalist id="variants">
                  {% for v in printful_variants %}
                    <option value="{{ v.id }}">{{ v.label }}</option>
                  {% endfor %}
                </datalist>
                <input type="text" name="thumbnail_url" placeholder="Thumbnail URL" value="{{ p.thumbnail_url or '' }}" />
                <textarea name="description" placeholder="Description">{{ p.description or '' }}</textarea>
                <button type="submit">Save</button>
              </form>
              <form method="post" enctype="multipart/form-data" action="/api/products/upload_image" style="margin-top:6px">
                <input type="hidden" name="sku" value="{{ p.sku }}" />
                <input type="file" name="image" accept="image/*" />
                <button type="submit">Upload Image</button>
              </form>
              <details style="margin-top:6px">
                <summary>Variants</summary>
                <form method="post" action="/api/products/variants/add" style="margin-top:6px">
                  <input type="hidden" name="sku" value="{{ p.sku }}" />
                  <input type="text" name="size" placeholder="Size (e.g., M)" />
                  <input type="text" name="color" placeholder="Color (e.g., Black)" />
                  <input type="text" name="printful_variant_id" placeholder="Printful variant id (optional)" />
                  <button type="submit">Add Variant</button>
                </form>
                {% set list = variants_map.get(p.sku) or [] %}
                {% if list %}
                <ul>
                  {% for v in list %}
                    <li>#{{ v.id }} — {{ v.size or 'ONE' }} / {{ v.color or 'NA' }} — PF: {{ v.printful_variant_id or '' }}
                      <form method="post" action="/api/products/variants/delete" style="display:inline">
                        <input type="hidden" name="id" value="{{ v.id }}" />
                        <button type="submit">Delete</button>
                      </form>
                    </li>
                  {% endfor %}
                </ul>
                {% else %}
                  <p style="opacity:0.7;">No variants defined.</p>
                {% endif %}
              </details>
              <form method="post" action="/api/products/generate_copy" style="margin-top:6px">
                <input type="hidden" name="sku" value="{{ p.sku }}" />
                <button type="submit">Generate Copy (ChatGPT)</button>
              </form>
              <form method="post" action="/api/products/etsy" style="margin-top:6px">
                <input type="hidden" name="sku" value="{{ p.sku }}" />
                <button type="submit">List to Etsy (draft)</button>
              </form>\n              <form method="post" action="/api/products/etsy_update_price" style="margin-top:6px">\n                <input type="hidden" name="sku" value="{{ p.sku }}" />\n                <button type="submit">Update Etsy Price</button>\n              </form>\n              <form method="post" action="/api/products/etsy_add_image_url" style="margin-top:6px">\n                <input type="hidden" name="sku" value="{{ p.sku }}" />\n                <input type="text" name="url" placeholder="Additional image URL" />\n                <button type="submit">Add Etsy Image (URL)</button>\n              </form>\n              <form method="post" enctype="multipart/form-data" action="/api/products/etsy_add_image" style="margin-top:6px">\n                <input type="hidden" name="sku" value="{{ p.sku }}" />\n                <input type="file" name="image" accept="image/*" />\n                <button type="submit">Add Etsy Image (Upload)</button>\n              </form>
              {% if p.etsy_listing_id %}
              <form method="post" action="/api/products/etsy_publish" style="margin-top:6px">
                <input type="hidden" name="sku" value="{{ p.sku }}" />
                <button type="submit">Publish Etsy Listing</button>
              </form>
              {% endif %}
              <form method="post" action="/api/products/printful" style="margin-top:6px">
                <input type="hidden" name="sku" value="{{ p.sku }}" />
                <button type="submit">Create in Printful</button>
              </form>
            </details>
            <form method="post" action="/api/products/etsy" style="display:inline;margin-right:6px">
              <input type="hidden" name="sku" value="{{ p.sku }}" />
              <button type="submit">List Draft</button>
            </form>
            <form method="post" action="/api/products/delete" style="display:inline">
              <input type="hidden" name="sku" value="{{ p.sku }}" />
              <button type="submit">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
    </table>\n</div>
  <div style="margin:8px 0;">
    <button type="submit">Bulk: Etsy Draft</button>
    <button type="submit" formaction="/api/products/bulk/etsy_publish">Bulk: Etsy Publish</button>
    <button type="submit" formaction="/api/products/bulk/printful">Bulk: Printful Create</button>
  </div>
  </form>
  {% else %}
    <p>No products yet.</p>
  {% endif %}
  <h2>Add Product</h2>
  <form method="post" action="/api/products">
    <input type="text" name="sku" placeholder="SKU" required />
    <input type="text" name="name" placeholder="Name" />
    <input type="text" name="price" placeholder="Price" />
    <input list="variants-new" type="text" name="variant_id" placeholder="Printful variant id (e.g., 4011)" />
    <datalist id="variants-new">
      {% for v in printful_variants %}
        <option value="{{ v.id }}">{{ v.label }}</option>
      {% endfor %}
    </datalist>
    <input type="text" name="thumbnail_url" placeholder="Thumbnail URL" />
    <textarea name="description" placeholder="Description"></textarea>
    <button type="submit">Add</button>
  </form>
{% endblock %}



